{
  "hash": "7f8f4430ca3ba0c59eeb238220e10004",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: '14-Extreme Value Estimation with Package FAmle'\ndate: \"2024-10-21\"\n---\n\n## Introduction\n\nHere, it is described how to fit distributions to a given hydrological data set. \nOur intention here is to provide an example how easy and powerful distribution fitting can be done in R. More information can be found in\nRice(2003), Hogg(2004), Coles (2001) and in the help file of package FAmle (Aucoin, 2001). For the\ngiven example, a data set from the US Geological Survey (USGS, http://waterdata.usgs.gov/nwis will\nbe employed. The dataset consists of annual maximum daily **peakflows** (ft3/s) that were observed at a\nhydrometric station located at River James (Columbia). First the packages and the data set is loaded, then it is tested for potential trends and autocorrelation\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## load required packages\nlibrary(\"FAmle\")\nlibrary(\"FAdist\")\nlibrary(\"MASS\")\nlibrary(\"zoo\")\nlibrary(\"readr\")\nlibrary(\"dplyr\")\nlibrary(\"lubridate\")\n```\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## St James River, Columbia\njamesriver <- read_csv(\"jamesriver.csv\", col_types = c(\"D\", \"n\"))\n\nflow <- jamesriver$flow\n\npar(mfrow=c(1, 2))\nplot(jamesriver$date, jamesriver$flow, type=\"b\", cex=0.4, pch=19, cex.axis=0.75, xlab=\"Year\", ylab=\"Flow\",\nmain=\"James River\")\nlines(lowess(jamesriver), col=\"red\")\nacf(jamesriver$flow, main=\"\")\n```\n\n::: {.cell-output-display}\n![Time series (left) and auto-correlation plot (right) the daily flow (in ft3/s data set. The red smoothed line corresponds to a lowess fit.](14-flood-risk_files/figure-html/fig-james-1.png){#fig-james width=672}\n:::\n:::\n\n\n\n## Empirical Quantiles\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhist(flow, probability=TRUE, xlab=\"flow (ft^3/s)\")\nrug(flow)\nlines(density(flow))\n```\n\n::: {.cell-output-display}\n![Histogram and empirical density of peak discharge.](14-flood-risk_files/figure-html/fig-james-hist-1.png){#fig-james-hist width=672}\n:::\n:::\n\n\nIf the data series is long enough, one may be tempted to use empirical quantiles, i.e. model and\nparameter free extrapolation from the data. We use this value as a baseline for the comparison with the\nmodel derived quantiles:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nquantile(p=c(0.95, 0.99), flow)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n 95%  99% \n4589 6974 \n```\n\n\n:::\n:::\n\n\n\n\n\n## Lognormal Distribution with 2 Parameters\n\nThe Lognormal distribution is often regarded as a plausible model for this type of data. However, other\ndistributions such as Weibull, Lognormal with three parameters, and Johnson distributions may provide\nbetter fitting results. We will try some of them.\nThe parameters of the distribution are estimated using maximum likelihood by the mle function con\ntained in package \"FAmle\", except for the Johnson distribution wich needs a different procedure.\nParameters of the fitting can be obtained as follows. It is important to pay attention to goodness-of-fit\nparameters (log likelihood and AIC) which provide us information about how good the model explains\nthe corresponding data set.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfitLn2 <- mle(x=flow, dist=\"lnorm\", start=c(0.1, 0.1))\nfitLn2\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n-----------------------------------------\n       Maximum Likelihood Estimates\n-----------------------------------------\nData object:  flow \nDistribution:  lnorm \n\n--------- Parameter estimates -----------\n\n         meanlog.hat sdlog.hat\nEstimate       6.294    1.4878\nStd.err        0.186    0.1319\n\n---------- Goodness-of-Fit --------------\n\n log.like       aic        ad       rho \n-518.8617 1041.7234    0.9627    0.9884 \n-----------------------------------------\n```\n\n\n:::\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## automatic diagnostic plots\nplot(x=fitLn2, ci=TRUE, alpha=0.05)\n\n## which probability has a flow >= 3000\n##  --> two functions to provide the same result:\n\n### standard R function\nplnorm(3000, meanlog=fitLn2$par.hat[1], sdlog=fitLn2$par.hat[2])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.8751862\n```\n\n\n:::\n\n```{.r .cell-code}\n### function from the FAmle package\ndistr(x=3000, dist=\"lnorm\", param=c(fitLn2$par.hat[1], fitLn2$par.hat[2]), type=\"p\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.8751862\n```\n\n\n:::\n\n```{.r .cell-code}\n## same for quantile (flow >= 95% quantile)\nqlnorm(p=0.95, meanlog=fitLn2$par.hat[1], sdlog=fitLn2$par.hat[2])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 6252.526\n```\n\n\n:::\n\n```{.r .cell-code}\ndistr(x=0.95, dist=\"lnorm\", param=c(fitLn2$par.hat[1], fitLn2$par.hat[2]), type=\"q\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 6252.526\n```\n\n\n:::\n\n```{.r .cell-code}\n## empirical quantile\nquantile(p=0.95, flow)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n 95% \n4589 \n```\n\n\n:::\n\n::: {.cell-output-display}\n![Plot of the mle object corresponding to the fitting James River data using a Lognormal distribution](14-flood-risk_files/figure-html/fig-mle-ln2-1.png){#fig-mle-ln2 width=672}\n:::\n:::\n\n\n\nThe function mle() provides also some goodness-of-fit statistics. This function creates a special\nkind of object which can be used inside of the standard R functions, e.g., plot(). A function called\nplot.mle may be used to generate a series of four diagnosis plots (@fig-mle-ln2) for the mle object.\nDiagnostic plots for the model fitted to the dataset. The dashed red lines correspond to the lower and\nupper confidence bounds (definded by alpha) of the approximated 95% confidence intervals derived\nusing the observed Fisher’s information matrix in conjunction with the so-called delta method.\n\nOnce the function is fitted to a distribution, these parameters can be used to calculate different quan-\ntiles. In this way we can find, for example, the value of the flow which has a probability lower than 5%\nor which is the probability of a flooding event of a certain flow.\n\n\n\n\nNow repeat for the 99% quantile\n \n...\n\nAnd extreme floods: 1% quantile\n\n...\n\nThe probability of a peakflow of 3000 ft3/s is obtained by either function \"plnorm\" or \"distr\" like\nfollows:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplnorm(3000, meanlog=fitLn2$par.hat[1], sdlog=fitLn2$par.hat[2], lower.tail=TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.8751862\n```\n\n\n:::\n\n```{.r .cell-code}\ndistr(x=3000, dist=\"lnorm\", param=fitLn2$par.hat, type=\"p\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.8751862\n```\n\n\n:::\n:::\n\n\n## Lognormal Distribution with 3 Parameters\n\nLet’s repeat the procedure for a Lognormal distribution with three parameters. In this case the package\nFAdist is required. Results are presented in @fig-mle-ln3\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Fit a lognormal distribution with three parameters\nfitLn3 <- mle(x=flow, dist=\"lnorm3\", start=c(0.5, 0.5, 0.5))\nfitLn3\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n-----------------------------------------\n       Maximum Likelihood Estimates\n-----------------------------------------\nData object:  flow \nDistribution:  lnorm3 \n\n--------- Parameter estimates -----------\n\n         shape.hat scale.hat thres.hat\nEstimate    1.4640    6.3065    -1.369\nStd.err     0.1552    0.1874     5.165\n\n---------- Goodness-of-Fit --------------\n\n log.like       aic        ad       rho \n-518.5289 1043.0578    0.8941    0.9891 \n-----------------------------------------\n```\n\n\n:::\n\n```{.r .cell-code}\n## diagnostic plots\nhist(flow, probability=TRUE)\nrug(flow)\nlines(density(flow))\nfunLn3 <- function(flow) distr(x=flow, model=fitLn3, type=\"d\")\ncurve(funLn3, add=TRUE, col=\"red\")\n\nplot(x=fitLn3, ci=TRUE, alpha=0.05)\n\n## theroretical and empirical quantiles\nqlnorm3(p=0.95, shape=fitLn3$par.hat[1], scale=fitLn3$par.hat[2], thres=fitLn3$par.hat[3])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 6089.576\n```\n\n\n:::\n\n```{.r .cell-code}\ndistr(x=0.95, dist=\"lnorm3\", param=c(fitLn3$par.hat[1], fitLn3$par.hat[2], fitLn3$par.hat[3]), type=\"q\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 6089.576\n```\n\n\n:::\n\n```{.r .cell-code}\nquantile(p=0.95, flow)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n 95% \n4589 \n```\n\n\n:::\n\n```{.r .cell-code}\n## Fit Weibull distribution to the data\nhist(flow, probability=TRUE)\nfitW <- mle(x=flow, dist=\"weibull\", start=c(0.1, 0.1))\nfitW\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n-----------------------------------------\n       Maximum Likelihood Estimates\n-----------------------------------------\nData object:  flow \nDistribution:  weibull \n\n--------- Parameter estimates -----------\n\n         shape.hat scale.hat\nEstimate   0.82050      1070\nStd.err    0.07811       172\n\n---------- Goodness-of-Fit --------------\n\n log.like       aic        ad       rho \n-515.2496 1034.4993    0.3602    0.9681 \n-----------------------------------------\n```\n\n\n:::\n\n```{.r .cell-code}\n## diagnostics\nfunW <- function(flow) distr(x=flow, model=fitW, type=\"d\")\ncurve(funW, add=TRUE, col=\"blue\")\n\nplot(x=fitW, ci=TRUE, alpha=0.05)\n\n## quantiles\nqweibull(p=0.99, shape=fitW$par.hat[1], scale=fitW$par.hat[2])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 6884.165\n```\n\n\n:::\n\n```{.r .cell-code}\ndistr(x=0.99, dist=\"weibull\", param=c(fitW$par.hat[1], fitW$par.hat[2]), type=\"q\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 6884.165\n```\n\n\n:::\n\n```{.r .cell-code}\nquantile(p=0.99, flow)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n 99% \n6974 \n```\n\n\n:::\n\n```{.r .cell-code}\n## Which distribution is the best according to the AIC?\nfitLn2$aic\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1041.723\n```\n\n\n:::\n\n```{.r .cell-code}\nfitLn3$aic\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1043.058\n```\n\n\n:::\n\n```{.r .cell-code}\nfitW$aic\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1034.499\n```\n\n\n:::\n\n::: {.cell-output-display}\n![Plot of the mle object corresponding to the fitting James River data using a LN3 distribution](14-flood-risk_files/figure-html/fig-mle-ln3-1.png){#fig-mle-ln3-1 width=672}\n:::\n\n::: {.cell-output-display}\n![Plot of the mle object corresponding to the fitting James River data using a LN3 distribution](14-flood-risk_files/figure-html/fig-mle-ln3-2.png){#fig-mle-ln3-2 width=672}\n:::\n\n::: {.cell-output-display}\n![Plot of the mle object corresponding to the fitting James River data using a LN3 distribution](14-flood-risk_files/figure-html/fig-mle-ln3-3.png){#fig-mle-ln3-3 width=672}\n:::\n\n::: {.cell-output-display}\n![Plot of the mle object corresponding to the fitting James River data using a LN3 distribution](14-flood-risk_files/figure-html/fig-mle-ln3-4.png){#fig-mle-ln3-4 width=672}\n:::\n:::\n\n\n\n## Exercise: Extreme values of the Elbe river\n\nNow load the Elbe River data from the beginning of the course and note that we need annual maximum values.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nelbe <- read_csv(\"https://raw.githubusercontent.com/tpetzoldt/datasets/main/data/elbe.csv\", , col_types = c(\"D\", \"n\"))\n\n\n## annual maximum discharge\nelbe_annual <-\n  mutate(elbe, year = year(date)) |>\n  group_by(year) |>\n  summarize(discharge = max(discharge))\n\nplot(discharge ~ year, data = elbe_annual)\n\n## check for trend and autocorrelation between years\nMannKendall(elbe_annual$discharge)\nacf(elbe_annual$discharge)\n\n\nfitLn3 <- mle(x=elbe_annual$discharge, dist=\"lnorm3\", start=c(1, 5, 100))\nfitLn3\n\nflow <- elbe_annual$discharge\n\nhist(flow, probability=TRUE, breaks = 10)\n\nrug(flow)\nlines(density(flow))\n\nxnew <- seq(min(flow), max(flow), length = 100)\nfunLn3 <- function(flow) distr(x=flow, model=fitLn3, type=\"d\")\nlines(xnew, funLn3(xnew), col=\"red\")\n```\n:::\n\n\n\n\n**Important:** The method described so far assumes stationarity of conditions, \ni.e. absence of meteorological and hydrological trends. Discuss, how climate \nwarming already influences validity of the described method, and which methods\nneed to be applied instead.\n\n",
    "supporting": [
      "14-flood-risk_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}