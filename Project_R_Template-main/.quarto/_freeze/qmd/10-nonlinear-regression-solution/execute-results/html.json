{
  "hash": "49c76cd3eac6a358d650d6e94352a557",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"x10-Fit Nonlinear Models to Plankton Growth Data\"\ndate: '2024-01-24'\nbibliography: nonlinear.bib\n---\n\n\n\n# Introduction\n\nThe growth rate of a population is a direct measure of fitness. Therefore, determination of growth rates is common in many disciplines of natural and human sciences, business and engineering: ecology, pharmacology, wastewater treatment, and economic growth. The following example gives a brief introduction, how growth models can be fitted wit **R**.\n\n# Material and methods\n\n## Data set\n\nThe example data set was taken from a growth experiment in a batch culture with \n*Microcystis aeruginosa*, a cyanobacteria (blue green algae) species. Details of \nthe experiment can be found in @Jahnichen2001.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## time (t)\nx <- c(0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20)\n## Algae cell counts (per ml)\ny <- c(0.88, 1.02, 1.43, 2.79, 4.61, 7.12,\n       6.47, 8.16, 7.28, 5.67, 6.91) * 1e6\n```\n:::\n\n\n## Methods\n\nParametric models are fitted using nonlinear regression according to the method of least squares.\nData analysis is performed using the **R** software of statistical computing and \ngraphics [@RCore] and the `nls` function from package **stats**. An additional \nanalysis is performed with packages **growthrates** [@growthrates] and **FME** [@FME]. \n\nTo get a suitable curve, we need a model that fits the data \nand that has identifiable parameters. In the following, we use the logistic growth model [@Verhulst1838]:\n\n\n$$\nN = \\frac{K \\cdot N_0}{(N_0 + (K - N_0) \\cdot \\exp(-r \\cdot x))} \n$$\n\nand the Baranyi-Roberts model [@Baranyi1994], explained later.\n\n# Results\n\nAfter some first attempts (not shown) it turned out that convergence can be difficult and required good start values.\n\nTo improve stability of the convergence, the tolerances of the optimization algorithm should be adapted to the scale on the data. As an alternative, we can also re-scale the data to a more common range, for example between $10^{-3}$ and $10^3$.\nThis is a rule of thumb, similar to what we usually do with measured quantities\nif we apply unit prefixes like micro, milli, kilo, mega:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nyy <- y * 1e-6\n```\n:::\n\n\nTo get a first impression of the data and at the same time, obtain good start parameters for the logistic model, we plot the data in both, with linear and logarithmic y-axis.\n\nWe see that the first points show the steepest increase,\nso we can estimate a start value of the exponential growth rate $r$ from the log-scaled data.\nThe straight line between two data points with steep \nincrease indicates the initial exponential phase. Here we use simply points number 1 and 5:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow=c(1, 2))\nplot(x, yy)\nplot(x, log(yy))\nr <- (log(yy[5]) - log(yy[1])) / (x[5] - x[1])\nabline(a = log(yy[1]), b=r)\n```\n\n::: {.cell-output-display}\n![](10-nonlinear-regression-solution_files/figure-html/linear-log-1.png){width=672}\n:::\n:::\n\n\nThis way, we have a heuristics for all start parameters:\n\n* $r$:  steepest increase of y in log scale\n* $K$: maximum value\n* $N_0$: initial population (first value)\n\n## Nonlinear regression with \"nls\"\n\n### Logistic Growth\n\nWe define now a used defined function for the logistic and this by plotting the \nfunction with the start values (blue line). Then we can use function `nls` \n(nonlinear least squares) to fit the model:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## function definition\nf <- function(x, r, K, N0) {K /(1 + (K/N0 - 1) * exp(-r *x))}\n\n## check of start values\nplot(x, yy, pch=16, xlab=\"time (days)\", ylab=\"algae (Mio cells)\")\nlines(x, f(x, r=r, K=max(yy), N0=yy[1]), col=\"blue\")\n\n## nonlinear regression\npstart <- c(r=r, K=max(yy), N0=yy[1])\nfit_logistic   <- nls(yy ~ f(x, r, K, N0), start = pstart, trace=FALSE)\n\nx1 <- seq(0, 25, length = 100)\nlines(x1, predict(fit_logistic, data.frame(x = x1)), col = \"red\")\nlegend(\"topleft\",\n       legend = c(\"data\", \"start parameters\", \"fitted parameters\"),\n       col = c(\"black\", \"blue\", \"red\"),\n       lty = c(0, 1, 1),\n       pch = c(16, NA, NA))\n```\n\n::: {.cell-output-display}\n![](10-nonlinear-regression-solution_files/figure-html/pstart-1.png){width=672}\n:::\n\n```{.r .cell-code}\nsummary(fit_logistic)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nFormula: yy ~ f(x, r, K, N0)\n\nParameters:\n   Estimate Std. Error t value Pr(>|t|)    \nr    0.5682     0.1686   3.371  0.00978 ** \nK    7.0725     0.4033  17.535 1.14e-07 ***\nN0   0.1757     0.1861   0.944  0.37271    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 0.8118 on 8 degrees of freedom\n\nNumber of iterations to convergence: 14 \nAchieved convergence tolerance: 4.018e-06\n```\n\n\n:::\n\n```{.r .cell-code}\n(Rsquared <- 1 - var(residuals(fit_logistic))/var(yy))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.931732\n```\n\n\n:::\n:::\n\n\nWe see that the fit converged and the red line approximates the data, but \nwe can also see that the model fit is far below the data at the beginning. This will be improved in the next section.\n\n### Baranyi-Roberts model\n\nThe logistic function assumes, that growth starts exponentially from the beginning and then approaches more and more saturation. In reality, organisms need often some time to adapt to new conditions, and we can observe a delay at the\nbeginnig. This delay is called *lag-phase*. Several models exist to describe such behavior, where the\nBaranyi-Roberts model [@Baranyi1994] is one of the most commonly used. Its parameters are similar\nto the logistic function with one additional parameter $h_0$ for the lag. Following its mathematical equation (not shown here),\nwe can implement it a suser-defined function in **R**:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbaranyi <- function(x, r, K, N0, h0) {\n  A <- x + 1/r * log(exp(-r * x) + exp(-h0) - exp(-r * x - h0))\n  y <- exp(log(N0) + r * A - log(1 + (exp(r * A) - 1)/exp(log(K) - log(N0))))\n  y\n}\n```\n:::\n\n\nIf we assume a lag time $h_0 = 2$, we can try to fit it and compare it with the logistic model\n\n\n::: {.cell}\n\n```{.r .cell-code}\npstart <- c(r=0.5, K=7, N0=1, h0=2)\nfit_baranyi   <- nls(yy ~ baranyi(x, r, K, N0, h0), start = pstart, trace=FALSE)\n\nplot(x, yy, pch=16, xlab=\"time (days)\", ylab=\"algae (Mio cells)\")\nlines(x1, predict(fit_logistic, data.frame(x = x1)), col = \"red\")\nlines(x1, predict(fit_baranyi, data.frame(x = x1)), col = \"forestgreen\", lwd=2)\n\nlegend(\"topleft\",\n       legend = c(\"data\", \"logistic model\", \"Baranyi-Roberts model\"),\n       col = c(\"black\", \"red\", \"forestgreen\"),\n       lty = c(0, 1, 1),\n       pch = c(16, NA, NA))\n```\n\n::: {.cell-output-display}\n![](10-nonlinear-regression-solution_files/figure-html/logistic-baranyi-1.png){width=672}\n:::\n:::\n\n\nIt is obvious, that it fits much better.\n\n## Growth curve fitting with R package \"growthrates\" \n\nAs growth curves are of fundamental importance in science and engineering, several **R** \npackages exist for this problem. Here we show one of these packages **growthrates** [@growthrates].\nDetails can be found in the \n[package documentation](https://tpetzoldt.github.io/growthrates/doc/Introduction.html).\n\n### Maximum growth rate as steepest increase in log scale\n\nThe package contains a method \"easy linear\" to find the steepest linear increase.\nIt  is a fully automatic method employing linear regression and a search\nroutine. Details of the algorithm are found in @Hall2014.\n\nThe following shows the phase of steepest increase, the exponential phase, identified \nby linear regression using the data points with the steepest increase:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"growthrates\")\npar(mfrow=c(1, 2))\nfit_easy <- fit_easylinear(x, yy)\nplot(fit_easy, main=\"linear scale\")\nplot(fit_easy, log=\"y\", main=\"log scale\")\n```\n\n::: {.cell-output-display}\n![](10-nonlinear-regression-solution_files/figure-html/growthrates-easy-1.png){width=672}\n:::\n\n```{.r .cell-code}\ncoef(fit_easy)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       y0     y0_lm     mumax       lag \n0.8800000 0.5838576 0.2528382 1.6226381 \n```\n\n\n:::\n:::\n\n\n### Logistic growth\n\nNow we can take the start parameters from above and function `fit_growthmodel` using \nthe `grow_logistic` function, that is pre-defined in the package. We can also use \na specific `plot` function from the package\n\n\n::: {.cell}\n\n```{.r .cell-code}\npstart <- c(mumax=r, K=max(yy), y0=yy[1])\nfit_logistic2 <- fit_growthmodel(grow_logistic, p=pstart, time=x, y=yy)\nplot(fit_logistic2)\n```\n\n::: {.cell-output-display}\n![](10-nonlinear-regression-solution_files/figure-html/rowthrates-logistic-1.png){width=672}\n:::\n:::\n\n\n### Baranyi-Roberts model\n\nWe see again that the model fits not very well at the beginning because of the lag\nphase. Therefore, we empoy again an extended model e.g. the Baranyi model.\n\nA start value for the lag phase parameter $h_0$ can be approximated from the \n\"easylinear\" method:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoef(fit_easy)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       y0     y0_lm     mumax       lag \n0.8800000 0.5838576 0.2528382 1.6226381 \n```\n\n\n:::\n\n```{.r .cell-code}\nh0 <- 0.25 * 1.66\n\npstart <- c(mumax=0.5, K=max(yy), y0=yy[1], h0=h0)\nfit_baranyi2 <- fit_growthmodel(grow_baranyi, p=pstart, time=x, y=yy)\nsummary(fit_baranyi2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nParameters:\n      Estimate Std. Error t value Pr(>|t|)    \nmumax   0.8477     0.3681   2.303   0.0547 .  \nK       6.9969     0.3499  19.999 1.96e-07 ***\ny0      0.9851     0.5250   1.876   0.1027    \nh0      4.1220     3.0894   1.334   0.2239    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 0.7583 on 7 degrees of freedom\n\nParameter correlation:\n        mumax       K      y0      h0\nmumax  1.0000 -0.3607  0.4600  0.9635\nK     -0.3607  1.0000 -0.1030 -0.2959\ny0     0.4600 -0.1030  1.0000  0.6477\nh0     0.9635 -0.2959  0.6477  1.0000\n```\n\n\n:::\n:::\n\n\nThe summary shows the parameter estimates, their standard error and a significance level. However, we should not take the significance stars too seriously here. If we would, for example, omit the \"nonsignificant\" parameters `y0` and `h0`,\nor set it to zero, the models would not work anymore. We see that some parameters correlate, especially `h0` and `y0`. This can, in principle, indicate identification problems, but this dod not happen here, fortunatly.\n\nFinally, we plot the results in both, linear and log scale:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow=c(1, 2))\nplot(fit_logistic2, ylim=c(0, 10), las=1)\nlines(fit_baranyi2, col=\"magenta\")\n\npoints(x, yy, pch=16, col=\"red\")\n\n## log scale\nplot(fit_logistic2, log=\"y\", ylim=c(0.2, 10), las=1)\npoints(x, yy, pch=16, col=\"red\")\nlines(fit_baranyi2, col=\"magenta\")\nlegend(\"bottomright\",\n       legend = c(\"data\", \"logistic model\", \"Baranyi model\"),\n       col = c(\"red\", \"blue\", \"magenta\"),\n       lty = c(0, 1, 1),\n       pch = c(16, NA, NA))\n```\n\n::: {.cell-output-display}\n![](10-nonlinear-regression-solution_files/figure-html/growthrates-fits-1.png){width=672}\n:::\n:::\n\n\n\n# Discussion\n\nWe see clear differences between the model fits, both quantitatively and qualitatively. The four-parameter-Baranyi model fitted better than the logistic, especially at the beginning. This results from the **lag phase** of cell counts, \nthat the logistic model cannot describe. We see this especially in the log-transformed plot. Whereas both functions\nhave sigmoidal shape in the left (linear) plot, only the Baranyi function remains sigmoidally with log-transformed y axis (right plot, magenta).\nIn contrast, growth is assumed to start exponentially in the logistic model, so that it starts approximately linear in the log scale (blue line, right).\n\n\n\n# References\n\n\n<!-- references automatically added from the data base / -->\n\n",
    "supporting": [
      "10-nonlinear-regression-solution_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}